\documentclass[a5paper,10pt]{article}

\usepackage{hyperref}

\usepackage{luatexja}
\usepackage{luatexja-fontspec}
\usepackage{luatexja-ruby}

\usepackage{expl3}
\usepackage{adjustbox}
\usepackage{calc}
\usepackage{fancyhdr}
\usepackage{ifthen}
\usepackage{pxpic}
\usepackage{enumitem}
\usepackage{titlesec}
\usepackage[xindy]{imakeidx}
\usepackage{xparse}

\indexsetup{level=\section,toclevel=section}
\makeindex[name=radical,title={部首索引},options={-L}]
\makeindex[name=sikrok,title={四角号碼索引},options={-L}]
\makeindex[name=phonetic,title={諧符索引},options={-L}]
\makeindex[name=zyevio,title={中古音索引},options={-L}]

\usepackage[marginpar=2cm]{geometry}

%\setmainfont{Junicode}
\setmainfont[Numbers={Lining,Monospaced}]{EB Garamond}
\setsansfont{Noto Sans}

\setmainjfont{Noto Serif CJK SC}
\setsansjfont{Noto Sans CJK SC}

% Make Greek and Cyrillic non-CJK
\ltjsetparameter{jacharrange={-2}}

% Make en-dash non-CJK
\ltjdefcharrange{8}{`–}


\newcommand{\textJapn}[1]{{%
    \newjfontfamily\fontMainJapn{Noto Serif CJK JP}[]%
    \newjfontfamily\fontSansJapn{Noto Sans CJK JP}[]%
    #1%
  }}
\newcommand{\textKor}[1]{{%
    \newjfontfamily\fontMainJapn{Noto Serif CJK KR}[]%
    \newjfontfamily\fontSansJapn{Noto Sans CJK KR}[]%
    #1%
  }}
\newcommand{\textHant}[1]{{%
    \newjfontfamily\fontMainHans{Noto Serif CJK SC}[]%
    \newjfontfamily\fontSansHans{Noto Sans CJK SC}[]%
    #1%
  }}
\newcommand{\textHans}[1]{{%
    \newjfontfamily\fontMainHans{Noto Serif CJK SC}[]%
    \newjfontfamily\fontSansHans{Noto Sans CJK SC}[]%
    #1%
  }}

% When the current style is m,
% attempting to change to bx,
% use bx if availabke,
% otherwise use b.
\DeclareFontShapeChangeRule{m}{bx}{bx}{b}

\newlength{\EntryDescriptionLineLength}
\newlength{\EntryDescriptionLineHeight}

\providecommand\phantomsection{}

\titleformat{\section}[display]
{%format
  \bfseries\large%
}{%label
  %(\thesection)%
}{%sep
  0pt
}{%before-code
  \centering
}
\titlespacing*{\section}{0pt}{*4}{0pt}

\ExplSyntaxOn

\tl_new:N \g_zqdict_entries_tl
\tl_new:N \g_zqdict_current_section_tl

\cs_set:Nn \_zqdict_xr_begin: {
  \tl_build_gbegin:N \g_zqdict_entries_tl
}
\cs_set:Nn \_zqdict_xr_section:nn {
  \tl_gset:Nn \g_zqdict_current_section_tl {{#1}{#2}}
}
\cs_set:Nn \_zqdict_xr_entry_begin:nn {
  \tl_build_gput_right:Nx \g_zqdict_entries_tl {{{begin}{#1}{#2}{\tl_use:N{\g_zqdict_current_section_tl}}}}
}
\cs_set:Nn \_zqdict_xr_entry_end:nn {
  \tl_build_gput_right:Nx \g_zqdict_entries_tl {{{end}{#1}{#2}{\tl_use:N{\g_zqdict_current_section_tl}}}}
}
\cs_set:Nn \_zqdict_xr_end: {
  \tl_build_gend:N \g_zqdict_entries_tl
}
\cs_set:Nn \_zqdict_entry_get_type:n {
  \tl_item:nn {#1} {1}
}
\cs_set:Nn \_zqdict_entry_get_headword:n {
  \tl_item:nn {#1} {2}
}
\cs_set:Nn \_zqdict_entry_get_page:n {
  \tl_item:nn {#1} {3}
}
\cs_set:Nn \_zqdict_entry_get_section:n {
  \tl_item:nn {#1} {4}
}

\cs_set:Nn \_zqdict_section_get_number:n {
  \tl_item:nn {#1} {1}
}
\cs_set:Nn \_zqdict_section_get_part:n {
  \tl_item:nn {#1} {2}
}

\cs_generate_variant:Nn \_zqdict_entry_get_type:n { o , x , V , v }
\cs_generate_variant:Nn \_zqdict_entry_get_headword:n { o , x , V , v }
\cs_generate_variant:Nn \_zqdict_entry_get_page:n { o , x , V , v }
\cs_generate_variant:Nn \_zqdict_entry_get_section:n { o , x , V , v }
\cs_generate_variant:Nn \_zqdict_section_get_number:n { o , x , V , v }
\cs_generate_variant:Nn \_zqdict_section_get_part:n { o , x , V , v }
\cs_generate_variant:Nn \tl_if_eq:nnTF { xnTF }
\cs_generate_variant:Nn \tl_if_eq:nnT { xnT }


\AtBeginDocument {
  \iow_now:cx { @auxout } {
    \token_to_str:N \ExplSyntaxOn
    \token_to_str:N \_zqdict_xr_begin:
    \token_to_str:N \ExplSyntaxOff
  }
}
\NewDocumentCommand{\RecordSection}{m m}{
  \iow_shipout_x:cn { @auxout } {
    \token_to_str:N \ExplSyntaxOn
    \token_to_str:N \_zqdict_xr_section:nn { #1 } { #2 }
    \token_to_str:N \ExplSyntaxOff
  }
}
\NewDocumentCommand{\RecordEntryBegin}{m}{
  \iow_shipout_x:cn { @auxout } {
    \token_to_str:N \ExplSyntaxOn
    \token_to_str:N \_zqdict_xr_entry_begin:nn { #1 } { \int_eval:n { \value { page } } }
    \token_to_str:N \ExplSyntaxOff
  }
}
\NewDocumentCommand{\RecordEntryEnd}{m}{
  \iow_shipout_x:cn { @auxout } {
    \token_to_str:N \ExplSyntaxOn
    \token_to_str:N \_zqdict_xr_entry_end:nn { #1 } { \int_eval:n { \value { page } } }
    \token_to_str:N \ExplSyntaxOff
  }
}
\AtEndDocument {
  \iow_now:cx { @auxout } {
    \token_to_str:N \ExplSyntaxOn
    \token_to_str:N \_zqdict_xr_end:
    \token_to_str:N \ExplSyntaxOff
  }
}

\str_new:N \l_zqdict_item_entry_type_str

\str_new:N \l_zqdict_current_part_str
\tl_new:N \l_zqdict_current_entry_tl
\str_new:N \l_zqdict_previous_part_str

\NewDocumentCommand{\ShowEntriesForTheCurrentPage}{}{
  \str_clear:N \l_zqdict_previous_part_str
  \tl_map_inline:Nn \g_zqdict_entries_tl {
    \str_set:Nx \l_zqdict_item_entry_type_str {
      \_zqdict_entry_get_type:n {##1}
    }

    \tl_if_eq:xnT {\_zqdict_entry_get_type:n {##1}} {begin} {
      \tl_set:Nn \l_zqdict_current_entry_tl {##1}
    }

    \tl_set:Nx \l_tmpa_tl {
      \_zqdict_entry_get_section:V \l_zqdict_current_entry_tl
    }
    \str_set:Nx \l_zqdict_current_part_str {
      \_zqdict_section_get_part:V \l_tmpa_tl
    }
    \bool_if:nT {
      (
        \str_if_eq_p:Vn \l_zqdict_item_entry_type_str { begin }
        &&
        \int_compare_p:nNn {\_zqdict_entry_get_page:V \l_zqdict_current_entry_tl} = { \value {page} }
      ) || (
        \str_if_eq_p:Vn \l_zqdict_item_entry_type_str { end }
        &&
        \int_compare_p:n {
          \_zqdict_entry_get_page:V \l_zqdict_current_entry_tl
          < \int_eval:n { \value {page} }
          <= \_zqdict_entry_get_page:n {##1}
        }
      )
    } {
      \str_if_eq:VVTF \l_zqdict_current_part_str \l_zqdict_previous_part_str {
        \hspace{0.25em}
      } {
        \str_if_eq:VnF \l_zqdict_previous_part_str {} {
          \quad
        }
        \textbf{
          {
            \ltjsetparameter{jacharrange={-9}}
            \_zqdict_section_get_number:V \l_tmpa_tl
          }
          \str_use:N \l_zqdict_current_part_str
        }
        \hspace{0.5em}
        \str_set:NV \l_zqdict_previous_part_str \l_zqdict_current_part_str
      }
      \_zqdict_entry_get_headword:V \l_zqdict_current_entry_tl
    }
    \int_compare:nNnT {\_zqdict_entry_get_page:V \l_zqdict_current_entry_tl} > {\value {page} } {
      \tl_map_break:n {}
    }
  }
}

\ExplSyntaxOff

\pagestyle{fancy}
\rhead{\small\ShowEntriesForTheCurrentPage}

\newcommand{\PartHeader}[5]{%
  \section[#1 #2 #3]{{\ltjsetparameter{jacharrange={-9}}#1}#2\MakeUppercase{#3}}%
  \RecordSection{#1}{#2}%
  \ifthenelse{\equal{#4}{}}{%
    \begin{center}
      #5%
    \end{center}
  }{%
    \begin{center}
      {\small #4}%

      #5%
    \end{center}
  }%
  \vspace{0.5em plus 0.2em minus 0.05em}
}
\NewDocumentEnvironment{Entry}{m m} {
  \noindent
  \setlength{\EntryDescriptionLineHeight}{2\baselineskip}%
  \setlength{\EntryDescriptionLineLength}{\linewidth-2\EntryDescriptionLineHeight}%
  \parshape 3
  \EntryDescriptionLineHeight \EntryDescriptionLineLength
  \EntryDescriptionLineHeight \EntryDescriptionLineLength
  0cm \linewidth%
  %
  \makebox[0pt][r]{%
    \fontseries{b}\fontsize{2\baselineskip}{2\baselineskip}\selectfont%
    \raisebox{-1ex}[0pt][0pt]{#1}%
    \hspace*{0.1em}%
  }%
  \makebox[0pt][l]{%
    \raisebox{-0ex}[0pt][0pt]{%
      \hspace{\EntryDescriptionLineLength+0.1\EntryDescriptionLineHeight}%
      \adjustbox{height=0.9\EntryDescriptionLineHeight,valign=t}{\pxpic[mode=px,colors={k=black,w=white}]{#2}}%
    }%
  }%
  \phantomsection%
  \addcontentsline{toc}{subsection}{#1}%
  \label{entry-#1}%
  \RecordEntryBegin{#1}%
}{%
  \RecordEntryEnd{#1}%
  \vspace{0.2em plus 0.5em minus 0.1em}%
  \pagebreak[3]%
}

\newenvironment{Sound}{\begin{itemize}[nosep,labelindent=0.5em,itemindent=-1em,leftmargin=1.5em]}{\end{itemize}}
\newcommand{\SoundItem}[1]{\item[]/{\zyepheng{#1}}/: }

\newenvironment{Sense}{\begin{itemize}[nosep,labelindent=0.5em,itemindent=-1em,leftmargin=1.5em]}{\end{itemize}}
\newcommand{\SenseItem}[1]{\item[]{\large\{\zyepheng{#1}\}}: }

\newcommand{\zyepheng}[1]{\textsf{#1}}

\newcommand{\SoundParts}[1]{{\ltjsetparameter{jacharrange={-9}}#1}}
\newcommand{\SoundPart}[2]{#1#2}
\newcommand{\SoundPartN}[1]{#1}
\newcommand{\SoundPartNI}[1]{#1}

\newcommand{\Sikrok}[2]{#1\textsubscript{#2}}
\newcommand{\refEntry}[1]{\hyperref[entry-#1]{#1}}

\newcommand{\Position}[1]{\texttt{\tiny #1}}

\newcommand{\Book}[1]{{《#1》}}

\begin{document}
\part{Examples}
やること
\begin{itemize}
\item{} 反切
  \begin{itemize}
  \item{} 「切韵本」欄以下の違いは何？
    \begin{itemize}
    \item 《P3695》+《P3696(p13)》
    \item 《切三》、《Дх1267》
    \end{itemize}
  \end{itemize}
\item{} 義
  \begin{itemize}
  \item{} 文献\kenten{以外}のラテン文字を隋拼扱い
  \end{itemize}
\item{} フォント
  \begin{itemize}
  \item{} 隋拼
    \begin{itemize}
    \item{} 隋拼
    \item{} aを一階建てに変更
    \item{} 重調符を下から上のものに変更
    \end{itemize}
  \item{} 本文書体
    \begin{itemize}
    \item{} 思源宋体
    \item{} 大きさを12Qに
    \end{itemize}
  \end{itemize}
\item{} データ
  \begin{itemize}
  \item{} 状態をオプションで取る
  \end{itemize}
\item{} 索引
  \begin{itemize}
  \item{} 四角
    \begin{itemize}
    \item{} 字形要素で纏めたものを再掲
    \end{itemize}
  \item{} 部首索引
    \begin{itemize}
    \item{} 新字体最優先、親字、異体字
    \item{} ?部 +?画
    \end{itemize}
  \item{} 頁数の代わりに諧聲符式を用いる
  \end{itemize}
\item{} 柱
  \begin{itemize}
  \item{} 外側にする
  \end{itemize}
\item{} 改頁
  \begin{itemize}
  \item{} 以下の改頁はできるだけ防ぐ。
    \begin{itemize}
    \item{} 節見出し中の改頁
    \item{} 節見出し直後での改頁
    \item{} 親字直後の改頁
    \end{itemize}
  \item{} 親字から字音まで一塊にしてみる?
  \end{itemize}
\item{} 紙面
  \begin{itemize}
  \item{} 余白の調整
  \item{} 頁番号位置・スタイルの調整
  \end{itemize}
\end{itemize}

\PartHeader{27}{冬聲}{toŋ}{}{\refEntry{冬}\refEntry{佟}{疼}{柊}{鼕}{螽}{終}}

\begin{Entry}{冬}{{k}}
  + 0（夊部0畫）
  \\
  \Sikrok{2730}{3}
  \begin{Sound}
    \SoundItem{toŋ}《P3798》都/宗[ha]反，端-冬平，上平聲二冬
  \end{Sound}
\end{Entry}

\begin{Entry}{佟}{{k}}
  \index[radical]{人部!5畫!佟}%
  \index[sikrok]{2723.3@\Sikrok{2723}{3}!佟}%
  \index[phonetic]{冬+23}%
  \index[zyevio]{doŋ!佟}%
  + 23人（人部5畫）
  \\
  \Sikrok{2723}{3}
  \begin{Sound}
    \SoundItem{doŋ}《P3798》徒冬反，定冬平
  \end{Sound}
\end{Entry}

\PartHeader{28}{中聲}{tuŋ}{}{\refEntry{中}仲忠}

\begin{Entry}{中}{{w}}%
  \index[radical]{丨部!3畫!中}%
  \index[sikrok]{5000.6@\Sikrok{5000}{6}}%
  \index[phonetic]{中+0}%
  \index[zyevio]{tryuŋ!中}%
  \index[zyevio]{tryûŋ!中}%
  \index[zyevio]{dryûŋ!中}%
  + 0。丨部3畫。
  \\
  \Sikrok{5000}{6}。
  \begin{Sound}
    \SoundItem{tryuŋ}《切二》陟隆反, 《廣韵》陟隆切, 知東平。上平聲一東（中間）。
    \SoundItem{tryûŋ}《P3696(1)r》陟仲反, 知送去。去聲一送（射中, 撃中）。
    \SoundItem{dryûŋ}《集韵》直衆切
  \end{Sound}
  \begin{Sense}
    \SenseItem{tryuŋ}義略。
    \SenseItem{tryûŋ}義略。
  \end{Sense}
\end{Entry}

\clearpage{}
\part{Generated}
\input{test-data.tex}
\part{Indices}
やること
\begin{itemize}
\item{} 正しい照合順序を実装
  \begin{itemize}
  \item{} 見出し字
  \item{} 部首
  \item{} 諧符
  \item{} 隋拼
  \end{itemize}
\item{} 見た目の調整
  \begin{itemize}
  \item{} 部見出し
  \item{} 見出し字と頁数
  \end{itemize}
\end{itemize}

\printindex[radical]
\printindex[sikrok]
\printindex[phonetic]
\printindex[zyevio]
\end{document}